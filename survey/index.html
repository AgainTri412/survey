<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>AI & Career Preparation Survey</title>
  <style>
    :root { --fg:#0b1220; --muted:#4b5563; --bd:#e5e7eb; --bg:#ffffff; --card:#f8fafc; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; color:var(--fg); background:var(--bg); }
    header { padding: 16px; border-bottom:1px solid var(--bd); position:sticky; top:0; background:#fff; z-index:10; }
    h1 { margin:0; font-size:18px; }
    .muted { color:var(--muted); font-size:13px; margin-top:4px; }
    main { max-width: 720px; margin: 0 auto; padding: 16px 16px 96px; }
    .card { background: var(--card); border:1px solid var(--bd); border-radius: 16px; padding: 14px; margin: 14px 0; }
    .title { font-weight:800; margin:0 0 6px; }
    label { display:block; font-weight:700; margin: 10px 0 6px; }
    input[type="text"], input[type="number"], select, textarea {
      width:100%; padding: 12px; border-radius: 12px; border:1px solid var(--bd); font-size:16px; background:#fff;
    }
    textarea { min-height: 96px; resize: vertical; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; }
    button {
      border:1px solid var(--bd); border-radius: 14px; padding: 12px 14px;
      font-size:16px; font-weight:800; cursor:pointer;
    }
    button.primary { background:#111827; color:#fff; }
    button.secondary { background:#fff; color:#111827; }
    .pillgrid { display:grid; grid-template-columns: 1fr; gap: 10px; margin-top: 8px; }
    .pill {
      display:flex; align-items:center; gap:10px; padding: 12px 12px;
      background:#fff; border:1px solid var(--bd); border-radius: 14px;
      min-height: 48px;
    }
    .req { color:#b91c1c; font-weight:900; margin-left:4px; }
    .hidden { display:none !important; }
    .err { color:#b91c1c; font-size: 14px; margin-top: 10px; }
    .ok { color:#065f46; font-size: 14px; margin-top: 10px; }
    .likertRow { margin-top: 10px; }
    .likertStmt { font-weight: 700; margin-bottom: 8px; }
    .likertChoices { display:grid; grid-template-columns: repeat(5, 1fr); gap: 8px; }
    .likertChoices label {
      font-weight: 700; text-align:center; border:1px solid var(--bd); border-radius: 12px;
      padding: 10px 0; background:#fff; margin:0;
      min-height: 44px; display:flex; align-items:center; justify-content:center;
    }
    .likertChoices input { position:absolute; opacity:0; pointer-events:none; }
    .likertChoices input:checked + span { background:#111827; color:#fff; border-radius: 10px; padding: 6px 10px; }
    .footer {
      position: fixed; left:0; right:0; bottom:0; background: rgba(255,255,255,.95);
      border-top:1px solid var(--bd); padding: 12px 16px; backdrop-filter: blur(6px);
    }
    .footerInner { max-width: 720px; margin:0 auto; display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .progress { font-size: 13px; color:var(--muted); }
    @media (max-width:420px){ .likertChoices { gap:6px; } }
  </style>
</head>
<body>
<header>
  <h1>AI & Career Preparation Survey</h1>
  <div class="muted">Mobile-friendly. Your progress is saved on this device.</div>
</header>

<main>
  <div class="card">
    <div class="title" id="stepTitle"></div>
    <div class="muted" id="stepDesc"></div>
    <div id="stepBody"></div>
    <div id="msg" class="err hidden"></div>
    <div id="ok" class="ok hidden"></div>
  </div>
</main>

<div class="footer">
  <div class="footerInner">
    <div class="progress" id="progress"></div>
    <div class="btnrow">
      <button class="secondary" id="backBtn" type="button">Back</button>
      <button class="primary" id="nextBtn" type="button">Next</button>
    </div>
  </div>
</div>

<script>
  // ---------- Model ----------
  const LS_KEY = "ai_career_survey_v1";

  const AI_CONCERN = [
    "Advancements in artificial intelligence will make it harder for people like me to find a job.",
    "I worry that AI will replace many entry-level jobs in my field.",
    "Because of AI, I am uncertain about the long-term value of my degree.",
    "AI development makes me feel anxious about my future career prospects.",
    "I feel that AI could negatively affect my chances of career success."
  ];
  const AI_OPP = [
    "AI will create new job opportunities in my field.",
    "AI can help me become more productive and effective in my future work.",
    "Learning to work with AI will improve my employability."
  ];
  const LEARN = [
    "I actively seek opportunities to learn new skills that may improve my career prospects.",
    "I enjoy learning new things, even when they are challenging.",
    "When my skills become outdated, I try to update them as quickly as possible.",
    "Continuous learning is essential for my future career success."
  ];
  const READY = [
    "I feel well prepared to enter the job market.",
    "I am confident in my ability to find a good job after graduation.",
    "I believe I have the skills employers are looking for.",
    "Compared to my peers, I feel ready for employment."
  ];

  const state = loadState() ?? {
    step: 0,
    consent: null,
    status: null,
    demographics: { age: "", gender: "", field: "", field_other: "", region: "" },
    ai_concern: Array(AI_CONCERN.length).fill(null),
    ai_opp: Array(AI_OPP.length).fill(null),
    ai_tools_used: null,
    ai_tools_freq: null,
    learn: Array(LEARN.length).fill(null),
    extra_courses: null,
    skills_focus: [],
    skills_other: "",
    internship: null,
    career_ready: Array(READY.length).fill(null),
    open_ended: ""
  };

  const steps = [
    { key:"consent", title:"Consent & Eligibility", desc:"Consent and eligibility are required to proceed.", render: renderConsent },
    { key:"demo", title:"Section A — Demographics", desc:"Please complete the required background questions.", render: renderDemographics },
    { key:"aic", title:"Section B — AI Concern", desc:"Tap one option for each statement. (1–5)", render: () => renderLikert("ai_concern", AI_CONCERN) },
    { key:"aio", title:"Section C — AI Opportunities", desc:"Tap one option for each statement. (1–5)", render: () => renderLikert("ai_opp", AI_OPP) },
    { key:"tools", title:"Section D — AI Tool Usage", desc:"AI tool usage and frequency.", render: renderTools },
    { key:"learn", title:"Section E — Learning Orientation", desc:"Tap one option for each statement. (1–5)", render: () => renderLikert("learn", LEARN) },
    { key:"skills", title:"Section F — Skill Development", desc:"Select all that apply.", render: renderSkills },
    { key:"intern", title:"Section G — Internship", desc:"Internship / work experience.", render: renderInternship },
    { key:"ready", title:"Section H — Career Readiness", desc:"Tap one option for each statement. (1–5)", render: () => renderLikert("career_ready", READY) },
    { key:"open", title:"Section I — Open-ended (Optional)", desc:"Optional text response.", render: renderOpenEnded },
    { key:"submit", title:"Submit", desc:"Submit your response to the server (stub) or download JSON.", render: renderSubmit }
  ];

  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);

  function saveState() { localStorage.setItem(LS_KEY, JSON.stringify(state)); }
  function loadState() {
    try { return JSON.parse(localStorage.getItem(LS_KEY)); } catch { return null; }
  }
  function setMsg(text, ok=false) {
    $("msg").classList.toggle("hidden", ok || !text);
    $("ok").classList.toggle("hidden", !ok || !text);
    $("msg").textContent = ok ? "" : text;
    $("ok").textContent = ok ? text : "";
  }
  function mean(arr) {
    const nums = arr.filter(v => typeof v === "number");
    if (nums.length !== arr.length) return null;
    return Math.round((nums.reduce((a,b)=>a+b,0) / nums.length) * 1000) / 1000;
  }

  // ---------- Rendering ----------
  function render() {
    setMsg("");
    const step = steps[state.step];
    $("stepTitle").textContent = step.title;
    $("stepDesc").textContent = step.desc;
    $("stepBody").innerHTML = "";
    step.render();

    $("progress").textContent = `Step ${state.step+1} of ${steps.length}`;
    $("backBtn").disabled = state.step === 0;
    $("nextBtn").textContent = state.step === steps.length-1 ? "Done" : "Next";
    saveState();
  }

  function renderConsent() {
    const el = $("stepBody");
    el.innerHTML = `
      <div class="muted">
        You are invited to participate in a survey about how students are preparing for the job market in the context of AI development.
        Participation is voluntary and anonymous.
      </div>

      <label style="margin-top:12px;">Do you consent to participate?<span class="req">*</span></label>
      <div class="pillgrid">
        ${radioPill("consent","yes","Yes, I consent", state.consent)}
        ${radioPill("consent","no","No, I do not consent", state.consent)}
      </div>

      <label style="margin-top:14px;">Which best describes you?<span class="req">*</span></label>
      <div class="pillgrid">
        ${radioPill("status","final_year","Final-year undergraduate student", state.status)}
        ${radioPill("status","grad_1yr","Graduate (within 1 year)", state.status)}
        ${radioPill("status","neither","Neither of the above", state.status)}
      </div>
    `;

    el.querySelectorAll('input[name="consent"]').forEach(i => i.addEventListener("change", e => { state.consent = e.target.value; saveState(); }));
    el.querySelectorAll('input[name="status"]').forEach(i => i.addEventListener("change", e => { state.status = e.target.value; saveState(); }));
  }

  function renderDemographics() {
    const d = state.demographics;
    const el = $("stepBody");
    el.innerHTML = `
      <label>Age<span class="req">*</span></label>
      <input type="number" inputmode="numeric" min="16" max="100" id="age" value="${escapeHtml(d.age)}" />

      <label>Gender<span class="req">*</span></label>
      <select id="gender">
        ${opt("", "Select…", d.gender, true)}
        ${opt("female","Female", d.gender)}
        ${opt("male","Male", d.gender)}
        ${opt("nonbinary_other","Non-binary / Other", d.gender)}
        ${opt("prefer_not","Prefer not to say", d.gender)}
      </select>

      <label>Field of study<span class="req">*</span></label>
      <select id="field">
        ${opt("", "Select…", d.field, true)}
        ${opt("stem","STEM", d.field)}
        ${opt("business_econ","Business / Economics", d.field)}
        ${opt("social_sciences","Social Sciences", d.field)}
        ${opt("arts_humanities","Arts & Humanities", d.field)}
        ${opt("other","Other", d.field)}
      </select>
      <div id="fieldOtherWrap" class="${d.field === "other" ? "" : "hidden"}">
        <label>Please specify (Other)</label>
        <input type="text" id="field_other" value="${escapeHtml(d.field_other)}" />
      </div>

      <label>Region where you are studying/studied<span class="req">*</span></label>
      <select id="region">
        ${opt("", "Select…", d.region, true)}
        ${opt("asia","Asia", d.region)}
        ${opt("europe","Europe", d.region)}
        ${opt("north_america","North America", d.region)}
        ${opt("latin_america","Latin America", d.region)}
        ${opt("africa","Africa", d.region)}
        ${opt("oceania","Oceania", d.region)}
        ${opt("prefer_not","Prefer not to say", d.region)}
      </select>
    `;

    el.querySelector("#age").addEventListener("input", e => state.demographics.age = e.target.value);
    el.querySelector("#gender").addEventListener("change", e => state.demographics.gender = e.target.value);
    el.querySelector("#field").addEventListener("change", e => {
      state.demographics.field = e.target.value;
      if (e.target.value !== "other") state.demographics.field_other = "";
      render(); // re-render to show/hide other
    });
    const fo = el.querySelector("#field_other");
    if (fo) fo.addEventListener("input", e => state.demographics.field_other = e.target.value);
    el.querySelector("#region").addEventListener("change", e => state.demographics.region = e.target.value);
  }

  function renderLikert(key, statements) {
    const el = $("stepBody");
    const vals = state[key];
    el.innerHTML = statements.map((s, idx) => `
      <div class="likertRow">
        <div class="likertStmt">${escapeHtml(s)}<span class="req">*</span></div>
        <div class="likertChoices">
          ${[1,2,3,4,5].map(v => `
            <label>
              <input type="radio" name="${key}_${idx}" value="${v}" ${vals[idx]===v ? "checked" : ""}/>
              <span>${v}</span>
            </label>
          `).join("")}
        </div>
      </div>
    `).join("");

    el.querySelectorAll(`input[type="radio"]`).forEach(r => {
      r.addEventListener("change", e => {
        const [k, idx] = e.target.name.split("_").slice(0,2);
        state[k][Number(idx)] = Number(e.target.value);
        saveState();
      });
    });
  }

  function renderTools() {
    const el = $("stepBody");
    el.innerHTML = `
      <label>Have you ever used AI-based tools for learning or career preparation?<span class="req">*</span></label>
      <div class="pillgrid">
        ${radioPill("ai_tools_used","yes","Yes", state.ai_tools_used)}
        ${radioPill("ai_tools_used","no","No", state.ai_tools_used)}
      </div>

      <div id="freq" class="${state.ai_tools_used === "yes" ? "" : "hidden"}">
        <label style="margin-top:14px;">How often do you use AI tools?<span class="req">*</span></label>
        <div class="pillgrid">
          ${radioPill("ai_tools_freq","rarely","Rarely", state.ai_tools_freq)}
          ${radioPill("ai_tools_freq","sometimes","Sometimes", state.ai_tools_freq)}
          ${radioPill("ai_tools_freq","often","Often", state.ai_tools_freq)}
        </div>
      </div>
    `;

    el.querySelectorAll('input[name="ai_tools_used"]').forEach(i => i.addEventListener("change", e => {
      state.ai_tools_used = e.target.value;
      if (state.ai_tools_used !== "yes") state.ai_tools_freq = null;
      render();
    }));
    el.querySelectorAll('input[name="ai_tools_freq"]').forEach(i => i.addEventListener("change", e => {
      state.ai_tools_freq = e.target.value;
      saveState();
    }));
  }

  function renderSkills() {
    const el = $("stepBody");
    const checked = new Set(state.skills_focus);
    const items = [
      ["communication","Communication"],
      ["teamwork","Teamwork"],
      ["creativity","Creativity"],
      ["critical_thinking","Critical thinking"],
      ["adaptability","Adaptability"],
      ["digital_technical","Digital / technical skills"],
      ["leadership","Leadership"],
      ["other","Other"]
    ];
    el.innerHTML = `
      <label>Have you completed any additional courses, certifications, or workshops outside your formal degree?<span class="req">*</span></label>
      <div class="pillgrid">
        ${radioPill("extra_courses","yes","Yes", state.extra_courses)}
        ${radioPill("extra_courses","no","No", state.extra_courses)}
      </div>

      <label style="margin-top:14px;">Which areas have you actively tried to improve during college? (Select all that apply)<span class="req">*</span></label>
      <div class="pillgrid">
        ${items.map(([v, label]) => checkboxPill("skills_focus", v, label, checked.has(v))).join("")}
      </div>

      <div id="skillsOtherWrap" class="${checked.has("other") ? "" : "hidden"}">
        <label>Please specify (Other)</label>
        <input type="text" id="skills_other" value="${escapeHtml(state.skills_other)}" />
      </div>
    `;

    el.querySelectorAll('input[name="extra_courses"]').forEach(i => i.addEventListener("change", e => {
      state.extra_courses = e.target.value;
      saveState();
    }));

    el.querySelectorAll('input[name="skills_focus"]').forEach(cb => cb.addEventListener("change", e => {
      const v = e.target.value;
      const set = new Set(state.skills_focus);
      if (e.target.checked) set.add(v); else set.delete(v);
      state.skills_focus = [...set];
      if (!set.has("other")) state.skills_other = "";
      render();
    }));

    const so = el.querySelector("#skills_other");
    if (so) so.addEventListener("input", e => { state.skills_other = e.target.value; saveState(); });
  }

  function renderInternship() {
    const el = $("stepBody");
    el.innerHTML = `
      <label>Have you completed any internships, co-op programs, or relevant part-time jobs?<span class="req">*</span></label>
      <div class="pillgrid">
        ${radioPill("internship","yes","Yes", state.internship)}
        ${radioPill("internship","no","No", state.internship)}
      </div>
    `;
    el.querySelectorAll('input[name="internship"]').forEach(i => i.addEventListener("change", e => { state.internship = e.target.value; saveState(); }));
  }

  function renderOpenEnded() {
    const el = $("stepBody");
    el.innerHTML = `
      <label>In your own words, how do you think AI will affect your future career, and how are you preparing for it? (Optional)</label>
      <textarea id="open">${escapeHtml(state.open_ended)}</textarea>
    `;
    el.querySelector("#open").addEventListener("input", e => { state.open_ended = e.target.value; saveState(); });
  }

  function renderSubmit() {
    const el = $("stepBody");
    const payload = buildPayload();
    const json = JSON.stringify(payload, null, 2);

    el.innerHTML = `
      <div class="muted">
        This version can submit to <code>/api/submit</code> (a stub endpoint) and/or let you download your response JSON.
      </div>

      <div style="margin-top:12px;" class="btnrow">
        <button class="primary" id="sendBtn" type="button">Submit to /api/submit</button>
        <button class="secondary" id="dlBtn" type="button">Download JSON</button>
        <button class="secondary" id="clearBtn" type="button">Clear saved progress</button>
      </div>

      <label style="margin-top:14px;">Preview JSON</label>
      <textarea readonly style="min-height:220px;">${escapeHtml(json)}</textarea>
    `;

    el.querySelector("#dlBtn").addEventListener("click", () => downloadJson(json));
    el.querySelector("#clearBtn").addEventListener("click", () => { localStorage.removeItem(LS_KEY); location.reload(); });

    el.querySelector("#sendBtn").addEventListener("click", async () => {
      setMsg("");
      try {
        const res = await fetch("/api/submit", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        const out = await res.json().catch(()=>({}));
        if (!res.ok) throw new Error(out?.error || `HTTP ${res.status}`);
        setMsg("Submitted successfully.", true);
      } catch (err) {
        setMsg("Submission failed: " + err.message);
      }
    });
  }

  function buildPayload() {
    return {
      meta: { submitted_at: new Date().toISOString(), instrument: "AI & Career Preparation Survey (paper-aligned)" },
      consent: { consented: state.consent === "yes", status: state.status },
      demographics: state.demographics,
      measures: {
        ai_concern_items: state.ai_concern,
        ai_concern_mean: mean(state.ai_concern),

        ai_opportunities_items: state.ai_opp,
        ai_opportunities_mean: mean(state.ai_opp),

        ai_tool_usage: { used: state.ai_tools_used === "yes", frequency: state.ai_tools_used === "yes" ? state.ai_tools_freq : null },

        learning_orientation_items: state.learn,
        learning_orientation_mean: mean(state.learn),

        extra_courses: state.extra_courses === "yes",
        soft_skills_focus: { selected: state.skills_focus, other_text: state.skills_focus.includes("other") ? (state.skills_other || null) : null },

        internship_experience: state.internship === "yes",

        career_readiness_items: state.career_ready,
        career_readiness_mean: mean(state.career_ready)
      },
      open_ended: state.open_ended || null
    };
  }

  // ---------- Validation + Navigation ----------
  function validateStep() {
    const key = steps[state.step].key;

    if (key === "consent") {
      if (!state.consent || !state.status) return "Please answer both consent and eligibility.";
      if (state.consent === "no") return "You did not consent. The survey cannot proceed.";
      if (state.status === "neither") return "You are not eligible for this survey.";
    }

    if (key === "demo") {
      const d = state.demographics;
      if (!d.age || !d.gender || !d.field || !d.region) return "Please complete all required demographic fields.";
      if (d.field === "other" && !d.field_other.trim()) return "Please specify your field of study (Other).";
    }

    if (key === "aic") {
      if (state.ai_concern.some(v => typeof v !== "number")) return "Please answer all AI Concern items.";
    }
    if (key === "aio") {
      if (state.ai_opp.some(v => typeof v !== "number")) return "Please answer all AI Opportunities items.";
    }
    if (key === "tools") {
      if (!state.ai_tools_used) return "Please answer whether you have used AI tools.";
      if (state.ai_tools_used === "yes" && !state.ai_tools_freq) return "Please select your AI tool usage frequency.";
    }
    if (key === "learn") {
      if (state.learn.some(v => typeof v !== "number")) return "Please answer all Learning Orientation items.";
    }
    if (key === "skills") {
      if (!state.extra_courses) return "Please answer whether you completed additional courses/certifications.";
      if (!state.skills_focus.length) return "Please select at least one skill area you are improving.";
      if (state.skills_focus.includes("other") && !state.skills_other.trim()) return "Please specify the 'Other' skill area.";
    }
    if (key === "intern") {
      if (!state.internship) return "Please answer the internship question.";
    }
    if (key === "ready") {
      if (state.career_ready.some(v => typeof v !== "number")) return "Please answer all Career Readiness items.";
    }
    return null;
  }

  $("nextBtn").addEventListener("click", () => {
    const err = validateStep();
    if (err) return setMsg(err);

    // hard gate: if in consent step and ineligible, stop.
    if (steps[state.step].key === "consent" && (state.consent === "no" || state.status === "neither")) {
      return setMsg("You cannot proceed. Please refresh if this was a mistake.");
    }

    if (state.step < steps.length - 1) {
      state.step += 1;
      render();
      window.scrollTo({ top:0, behavior:"smooth" });
    } else {
      setMsg("Done.", true);
    }
  });

  $("backBtn").addEventListener("click", () => {
    setMsg("");
    if (state.step > 0) {
      state.step -= 1;
      render();
      window.scrollTo({ top:0, behavior:"smooth" });
    }
  });

  // ---------- UI building blocks ----------
  function radioPill(name, value, label, current) {
    const checked = current === value ? "checked" : "";
    return `<label class="pill"><input type="radio" name="${name}" value="${value}" ${checked}/> ${escapeHtml(label)}</label>`;
  }
  function checkboxPill(name, value, label, checked) {
    return `<label class="pill"><input type="checkbox" name="${name}" value="${value}" ${checked ? "checked" : ""}/> ${escapeHtml(label)}</label>`;
  }
  function opt(value, label, current, disabled=false) {
    return `<option value="${value}" ${disabled ? "disabled" : ""} ${current===value ? "selected":""}>${label}</option>`;
  }
  function escapeHtml(s){ return String(s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;"); }

  function downloadJson(json) {
    const blob = new Blob([json], { type:"application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `survey_response_${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  // Initial render
  render();
</script>
</body>
</html>
